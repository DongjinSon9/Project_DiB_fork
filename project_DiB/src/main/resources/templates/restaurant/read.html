<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Restaurant Details</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"
            integrity="sha384-oBqDVmMz9ATKxIep9tiCxS/Z9fNfEXiDAYTujMAeBAsjFuCZSmKbSSUnQlmh/jp3"
            crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
            integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
            crossorigin="anonymous"></script>
</head>

<body>
<header class="d-flex flex-wrap align-items-center justify-content-center justify-content-md-between py-3 mb-2 border-bottom">
    <div class="col-md-3 mb-2 mb-md-0">
    </div>
    <ul class="nav col-12 col-md-auto mb-2 justify-content-center mb-md-0">
        <li><a href="#" class="nav-link px-2 link-secondary">Home</a></li>
        <li><a href="#" class="nav-link px-2">Features</a></li>
        <li><a href="#" class="nav-link px-2">Pricing</a></li>
        <li><a href="#" class="nav-link px-2">FAQs</a></li>
        <li><a href="#" class="nav-link px-2">About</a></li>
    </ul>
    <div class="col-md-3 text-end">
        <button type="button" class="btn btn-outline-primary me-2">Login</button>
        <button type="button" class="btn btn-primary">Sign-up</button>
    </div>
</header>

<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h2 th:text="${dto.rest_name}">Restaurant Name</h2>
            <p th:text="${dto.rest_exp}">Restaurant Description</p>
            <p th:text="${dto.rest_exp2}">Detailed Description</p>
            <p><strong>Location:</strong> <span th:text="${dto.rest_loc}">Location</span></p>
            <p><strong>Phone:</strong> <span th:text="${dto.rest_phone}">Phone</span></p>
            <p><strong>Menu:</strong> <span th:text="${dto.rest_menu}">Menu</span></p>
            <p><strong>Operating Hours:</strong> <span th:text="${dto.rest_time}">Operating Hours</span></p>
        </div>
    </div>
    <div class="row">
        <div class="col-12">
            <h3>Uploaded Images</h3>
            <div class="row">
                <div th:each="file : ${dto.fileNames}" class="col-md-3 mb-3">
                    <img th:src="@{|/view/${file}|}" class="img-fluid rounded" alt="Restaurant Image">
                </div>
            </div>
        </div>
    </div>
    <div class="row mt-4">
        <div class="col-12">
            <a href="/restaurant/list" class="btn btn-secondary">Back to List</a>
            <a sec:authorize="hasRole('ROLE_ADMIN')" th:href="@{/restaurant/modify(rno=${dto.rno})}"
               class="btn btn-primary">Modify</a>
        </div>
    </div>

    <div class="row mt-4" >
        <div class="col-12" >
            <h3>Reviews</h3>
            <div id="reviewList">
                <!-- 댓글 목록이 여기에 추가됩니다 -->
            </div>
            <nav aria-label="Page navigation">
                <ul class="pagination justify-content-center" id="pagination"></ul>
            </nav>
        </div>
    </div>

    <div class="row mt-4" >
        <div class="col-12" >
            <h3>Add a Review</h3>
            <form th:action="@{/replies/addReply}" method="post">
                <input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}">
                <div class="mb-3">
                    <label for="review_text" class="form-label">Review</label>
                    <textarea class="form-control" id="review_text" name="review_text" rows="3" required></textarea>
                </div>
                <input type="hidden" name="rno" th:value="${dto.rno}">
                <div class="mb-3">
                    <button type="submit" class="btn btn-primary">Submit Review</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 댓글 삭제 및 수정 폼 추가 -->
<form id="deleteForm" th:action="@{/replies/delete}" method="post" style="display: none;">
    <input type="hidden" name="review_no" id="deleteReviewNo">
    <input type="hidden" name="mid" id="deletemid">
    <input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}">
</form>

<form id="updateForm" th:action="@{/replies/update}" method="post" style="display: none;">
    <input type="hidden" name="review_no" id="updateReviewNo">
    <input type="hidden" name="review_text" id="updateReviewText">
    <input type="hidden" name="mid" id="updatemid">
    <input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}">
</form>

<footer class="py-5 text-center text-body-secondary bg-body-tertiary mt-4">
    <p>Blog template built for <a href="https://getbootstrap.com/">Bootstrap</a> by <a
            href="https://twitter.com/mdo">@mdo</a>.</p>
    <p class="mb-0">
        <a href="#">Back to top</a>
    </p>
</footer>

<script th:inline="javascript">
    $(document).ready(function () {
        const rno = /*[[${dto.rno}]]*/ 0;
        const pageSize = 10;
        let currentPage = 1;
        function loadReviews(page) {
            $.get(`/replies/list/${rno}?page=${page}&size=${pageSize}`, function (data) {
                let reviewList = $("#reviewList");
                reviewList.empty();
                let name = Object.keys(data)[0]
                console.log(Object.values(data)[0])
                Object.values(data)[0].dtoList.forEach(function (review) {
                    let reviewCard = `
                        <div class="card mb-3">
                            <div class="card-body">
                                <p class="card-text">${review.review_text}</p>
                                <footer class="blockquote-footer">By ${review.mid}</footer>
                    `;
                    if(name === review.mid || name==='ADMIN'){
                    reviewCard += `
                                    <button class="btn btn-primary btn-sm edit-btn" data-review-id="${review.review_no}" data-user-id="${review.mid}">Edit</button>
                                    <button class="btn btn-danger btn-sm delete-btn" data-review-id="${review.review_no}" data-user-id="${review.mid}">Delete</button>
                                `}
                    reviewCard += `</div>
                        </div>`
                    reviewList.append(reviewCard);
                });

                // 페이지 네비게이션 생성
                let pagination = $("#pagination");
                pagination.empty();
                if (data.prev) {
                    pagination.append(
                        `<li class="page-item">
                            <a class="page-link" href="#" aria-label="Previous" data-page="${data.start - 1}">
                                <span aria-hidden="true">&laquo;</span>
                            </a>
                        </li>`
                    );
                }
                for (let i = data.start; i <= data.end; i++) {
                    let activeClass = i === data.page ? "active" : "";
                    pagination.append(
                        `<li class="page-item ${activeClass}">
                            <a class="page-link" href="#" data-page="${i}">${i}</a>
                        </li>`
                    );
                }
                if (data.next) {
                    pagination.append(
                        `<li class="page-item">
                            <a class="page-link" href="#" aria-label="Next" data-page="${data.end + 1}">
                                <span aria-hidden="true">&raquo;</span>
                            </a>
                        </li>`
                    );
                }
            });
        }

        loadReviews(currentPage);

        // 페이지 네비게이션 클릭 시
        $("#pagination").on("click", ".page-link", function (e) {
            e.preventDefault();
            currentPage = $(this).data("page");
            loadReviews(currentPage);
        });

        // 댓글 수정 버튼 클릭 시
        $("#reviewList").on("click", ".edit-btn", function () {
            let reviewId = $(this).data("review-id");
            let userId = $(this).data("user-id");
            let reviewText = prompt("Edit your review:");
            if (reviewText) {
                $("#updateReviewNo").val(reviewId);
                $("#updateReviewText").val(reviewText);
                $("#updatemid").val(userId);
                $("#updateForm").submit();
            }
        });

        // 댓글 삭제 버튼 클릭 시
        $("#reviewList").on("click", ".delete-btn", function () {
            let reviewId = $(this).data("review-id");
            let userId = $(this).data("user-id");
            if (confirm("Are you sure you want to delete this review?")) {
                $("#deleteReviewNo").val(reviewId);
                $("#deletemid").val(userId);
                $("#deleteForm").submit();
            }
        });
    });
</script>
</body>

</html>
